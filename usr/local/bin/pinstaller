#!/bin/bash

# pinstaller.sh: A script to manage software installations dynamically

# Get the directory of the current script
SCRIPT_DIR=$(dirname "$(realpath "$0")")

# Source configuration file
CONFIG_FILE="$SCRIPT_DIR/config.sh"
if [ -f "$CONFIG_FILE" ]; then
  source "$CONFIG_FILE"
else
  echo "Configuration file not found! Exiting..."
  exit 1
fi

# Directory to store downloaded installers
INSTALLERS_DIR="/tmp/pinstaller_installers"
mkdir -p "$INSTALLERS_DIR"

# Ensure the 'dialog' utility is installed
echo "Checking for 'dialog' utility..."
if ! command -v dialog > /dev/null 2>&1; then
  echo "'dialog' is not installed. Installing it now..."
  if sudo apt install -y dialog; then
    echo "'dialog' installed successfully."
  else
    echo "Failed to install 'dialog'. Please check your system and try again."
    exit 1
  fi
else
  echo "'dialog' is already installed."
fi

# Fetch the latest installers
echo "Fetching the latest installation scripts..."
if [ -d "$INSTALLERS_DIR/.git" ]; then
  git -C "$INSTALLERS_DIR" pull
else
  git clone "$INSTALLER_REPO_URL" "$INSTALLERS_DIR"
fi

if [ $? -ne 0 ]; then
  echo "Failed to fetch the installation scripts. Please check your internet connection or the repository URL."
  exit 1
fi

# Function to run the program's installation script
run_install_script() {
  local program=$1
  local manager=$2

  # Check if the script exists for the selected program and package manager
  if [ -f "$INSTALLERS_DIR/$program/$manager/install.sh" ]; then
    # Run the installation script
    bash "$INSTALLERS_DIR/$program/$manager/install.sh"
  else
    echo "Installation script for $program with $manager not found."
    exit 1
  fi
}

# Display a menu with a list of programs
program=$(dialog --clear --title "Program Installer" \
  --menu "Select a program to install:" 15 50 5 \
  1 "Firefox" \
  2 "Docker" \
  3 "GNOME Tweaks" \
  4 "VLC Media Player" \
  5 "Visual Studio Code" \
  2>&1 >/dev/tty)

# Check if the user clicked cancel (exit code 1)
if [ $? -ne 0 ]; then
  clear
  echo "No program selected. Exiting..."
  exit 0
fi

clear  # Clear the dialog screen

# Map program selection to corresponding program name
case $program in
  1)
    program="firefox"
    ;;
  2)
    program="docker"
    ;;
  3)
    program="tweaks"
    ;;
  4)
    program="vlc"
    ;;
  5)
    program="vscode"
    ;;
  *)
    clear
    echo "No valid program selected."
    exit 1
    ;;
esac

# Generate package manager options dynamically based on available directories
managers=()
counter=1
for dir in "$INSTALLERS_DIR/$program"/*; do
  if [ -d "$dir" ]; then
    manager_name=$(basename "$dir")
    managers+=("$counter" "$manager_name")
    ((counter++))
  fi
done

# Display the package manager selection dynamically based on available managers
manager=$(dialog --clear --title "Select Package Manager" \
  --menu "Choose a package manager for $program:" 15 50 5 \
  "${managers[@]}" \
  2>&1 >/dev/tty)

# Check if the user clicked cancel (exit code 1)
if [ $? -ne 0 ]; then
  clear
  echo "No package manager selected. Exiting..."
  exit 0
fi

clear  # Clear the dialog screen

# Map manager selection to corresponding package manager
manager_name=${managers[$manager*2-2+1]}

# Run the installation script
run_install_script "$program" "$manager_name"

exit 0
